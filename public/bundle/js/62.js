(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[62],{98062:(i,t,e)=>{"use strict";e.r(t),e.d(t,{default:()=>Plugin});var n=e(57956),s=e(22819),o=e(97542),a=e(73339);class Plugin extends o.Y{constructor(){super(...arguments),this.name="plugin",this.data=new a.e}async init(i,t){[this.ses,this.sdk,this.pluginConfigDataModule]=await Promise.all([t.getModuleBySymbol(n.y.SES),t.getModuleBySymbol(n.y.SDK),t.getModuleBySymbol(n.y.PLUGIN_CONFIG_DATA_MODULE)]),i.loadConfiguredPlugins&&await this.loadConfigured(),t.market.register(this,a.e,this.data)}async loadConfigured(){if(this.pluginConfigDataModule.registryLoaded){const i=await this.pluginConfigDataModule.getConfiguredPlugins();this.log.debug("Combined configuration with registry data, loading plugins: "+JSON.stringify(i,void 0,2));for(const t of i)this.load(t)}}async fetchPlugin(i,t,e,n){n&&this.ses.freezeForStrict();const s=await this.ses.makeSecureEnvironment(i+""+(e?"-"+e:""),t,n);if(s){return[s,s.compartment.globalThis.plugin]}return null}unload(i){var t;const e=i.id&&""!==i.id?i.id:"default",n={applicationKey:i.applicationKey,id:e},s=this.data.get(n);if(s){if(null===(t=s.module)||void 0===t?void 0:t.dispose)try{s.module.dispose()}catch(i){this.log.warn("An error occurred when disposing a plugin, it may be in a partially disposed state",i)}s.disposeEnv(),this.data.delete(n)}}async load(i){const{applicationKey:t,src:e,id:n,strict:s}=i,o=void 0===s||s,a=n||"default",l={applicationKey:t,id:a};if(this.data.get(l))return Promise.reject(`Plugin for ${t}-${a} already loaded.`);const[d,r]=await this.fetchPlugin(t,e,a,o)||[];d&&r&&this.initPlugin(d,r.factory,i)}async initPlugin(i,t,e){const n=t(),{applicationKey:o,id:a,config:l}=e;let d=()=>{};if(n.init){class BundleConnector{constructor(i,t){this.sdk=i,this.options=t}connect(){return this.sdk.connect(`${window.location.protocol}//${window.location.host}`,this.options)}cancelConnecting(){}}class BundleMessengerFactoryFetcher{getFactory(i){return i.messengerFactory}}const i=await s.tK.connect(new BundleConnector(this.sdk,{applicationKey:o}),new BundleMessengerFactoryFetcher,window);n.init(i,l),d=()=>i.disconnect()}const r={applicationKey:o,id:a};this.data.set(r,n,(()=>{i.dispose(),d()}))}dispose(){var i;for(const[t,e]of this.data.plugins.entries())(null===(i=e.module)||void 0===i?void 0:i.dispose)&&e.module.dispose(),e.disposeEnv();this.data.plugins.clear()}}}}]);